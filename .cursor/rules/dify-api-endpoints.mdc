---
description:
globs:
alwaysApply: false
---
# Dify API ç«¯ç‚¹å®Œæ•´æŒ‡å—

æœ¬è§„åˆ™æä¾› AgentifUI é¡¹ç›®ä¸­æ‰€æœ‰ Dify API ç«¯ç‚¹çš„å®Œæ•´åˆ—è¡¨ã€ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

## æ ¸å¿ƒæ¶æ„

AgentifUI ä½¿ç”¨ä¸‰å±‚æ¶æ„å¤„ç† Dify API é›†æˆï¼š

1. **ä»£ç†å±‚**: [app/api/dify/[appId]/[...slug]/route.ts](mdc:app/api/dify/[appId]/[...slug]/route.ts) - å¤„ç†è®¤è¯å’Œè¯·æ±‚è½¬å‘
2. **æœåŠ¡å±‚**: [lib/services/dify/](mdc:lib/services/dify/) - ä¸šåŠ¡é€»è¾‘å’Œ API è°ƒç”¨
3. **ç±»å‹å±‚**: [lib/services/dify/types.ts](mdc:lib/services/dify/types.ts) - TypeScript ç±»å‹å®šä¹‰

## å®Œæ•´ API ç«¯ç‚¹åˆ—è¡¨

### ğŸ’¬ èŠå¤©ç›¸å…³ (Chat)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/chat-messages` | POST | `streamDifyChat` | [chat-service.ts](mdc:lib/services/dify/chat-service.ts) |
| `/chat-messages/{task_id}/stop` | POST | `stopDifyStreamingTask` | [chat-service.ts](mdc:lib/services/dify/chat-service.ts) |

### âš™ï¸ å·¥ä½œæµç›¸å…³ (Workflow)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/workflows/run` | POST | `executeDifyWorkflow`, `streamDifyWorkflow` | [workflow-service.ts](mdc:lib/services/dify/workflow-service.ts) |
| `/workflows/runs/{workflow_run_id}/stop` | POST | `stopDifyWorkflow` | [workflow-service.ts](mdc:lib/services/dify/workflow-service.ts) |
| `/workflows/runs/{workflow_run_id}` | GET | `getDifyWorkflowRunDetail` | [workflow-service.ts](mdc:lib/services/dify/workflow-service.ts) |
| `/workflows/logs` | GET | `getDifyWorkflowLogs` | [workflow-service.ts](mdc:lib/services/dify/workflow-service.ts) |

### ğŸ“± åº”ç”¨ç®¡ç† (App)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/parameters` | GET | `getDifyAppParameters` | [app-service.ts](mdc:lib/services/dify/app-service.ts) |
| `/info` | GET | `getDifyAppInfo` | [app-service.ts](mdc:lib/services/dify/app-service.ts) |
| `/site` | GET | `getDifyWebAppSettings` | [app-service.ts](mdc:lib/services/dify/app-service.ts) |
| `/meta` | GET | `getDifyAppMeta` | [app-service.ts](mdc:lib/services/dify/app-service.ts) |

### ğŸ’¬ æ¶ˆæ¯ç®¡ç† (Messages)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/messages` | GET | `getConversationMessages` | [message-service.ts](mdc:lib/services/dify/message-service.ts) |
| `/messages/{message_id}/feedbacks` | POST | `submitMessageFeedback` | [message-service.ts](mdc:lib/services/dify/message-service.ts) |
| `/audio-to-text` | POST | `convertAudioToText` | [message-service.ts](mdc:lib/services/dify/message-service.ts) |

### ğŸ—¨ï¸ å¯¹è¯ç®¡ç† (Conversations)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/conversations` | GET | `getConversations` | [conversation-service.ts](mdc:lib/services/dify/conversation-service.ts) |
| `/conversations/{conversation_id}` | DELETE | `deleteConversation` | [conversation-service.ts](mdc:lib/services/dify/conversation-service.ts) |
| `/conversations/{conversation_id}` | PATCH | `renameConversation` | [conversation-service.ts](mdc:lib/services/dify/conversation-service.ts) |
| `/conversations/{conversation_id}/variables` | GET | `getConversationVariables` | [conversation-service.ts](mdc:lib/services/dify/conversation-service.ts) |

### ğŸ“ æ–‡æœ¬ç”Ÿæˆ (Completion)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/completion-messages` | POST | `executeDifyCompletion`, `streamDifyCompletion` | [completion-service.ts](mdc:lib/services/dify/completion-service.ts) |
| `/completion-messages/{task_id}/stop` | POST | `stopDifyCompletion` | [completion-service.ts](mdc:lib/services/dify/completion-service.ts) |

### ğŸ“‹ æ ‡æ³¨ç®¡ç† (Annotations)

| ç«¯ç‚¹ | æ–¹æ³• | æœåŠ¡å‡½æ•° | æ–‡ä»¶ä½ç½® |
|------|------|----------|----------|
| `/apps/annotations` | GET | `getDifyAnnotations` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |
| `/apps/annotations` | POST | `createDifyAnnotation` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |
| `/apps/annotations/{annotation_id}` | PUT | `updateDifyAnnotation` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |
| `/apps/annotations/{annotation_id}` | DELETE | `deleteDifyAnnotation` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |
| `/apps/annotation-reply/{action}` | POST | `setDifyAnnotationReplySettings` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |
| `/apps/annotation-reply/{action}/status/{job_id}` | GET | `getDifyAnnotationReplyJobStatus` | [annotation-service.ts](mdc:lib/services/dify/annotation-service.ts) |

## ä½¿ç”¨ç¤ºä¾‹

### å¯¼å…¥æœåŠ¡å‡½æ•°

```typescript
// ä»ç»Ÿä¸€å…¥å£å¯¼å…¥
import { 
  streamDifyChat, 
  getDifyAnnotations,
  createDifyAnnotation 
} from '@lib/services/dify';

// æˆ–ä»å…·ä½“æœåŠ¡æ–‡ä»¶å¯¼å…¥
import { streamDifyChat } from '@lib/services/dify/chat-service';
```

### èŠå¤©æœåŠ¡ä½¿ç”¨

```typescript
const response = await streamDifyChat(appId, {
  query: "ä½ å¥½",
  user: "user123",
  response_mode: "streaming"
});

for await (const chunk of response.answerStream) {
  console.log(chunk);
}
```

### æ ‡æ³¨ç®¡ç†ä½¿ç”¨

```typescript
// è·å–æ ‡æ³¨åˆ—è¡¨
const annotations = await getDifyAnnotations(appId, { page: 1, limit: 20 });

// åˆ›å»ºæ–°æ ‡æ³¨
const newAnnotation = await createDifyAnnotation(appId, {
  question: "ä»€ä¹ˆæ˜¯AIï¼Ÿ",
  answer: "äººå·¥æ™ºèƒ½æ˜¯..."
});
```

## é”™è¯¯å¤„ç†

æ‰€æœ‰æœåŠ¡å‡½æ•°éƒ½ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```typescript
try {
  const result = await someService(appId, params);
  // å¤„ç†æˆåŠŸç»“æœ
} catch (error) {
  if (error.status === 401) {
    // å¤„ç†è®¤è¯é”™è¯¯
  } else if (error.status === 429) {
    // å¤„ç†é™æµé”™è¯¯
  } else {
    // å¤„ç†å…¶ä»–é”™è¯¯
  }
}
```

## ç±»å‹å®‰å…¨

æ‰€æœ‰ API ç›¸å…³çš„ç±»å‹å®šä¹‰éƒ½åœ¨ [lib/services/dify/types.ts](mdc:lib/services/dify/types.ts) ä¸­ï¼š

- è¯·æ±‚ä½“ç±»å‹ï¼š`Dify*RequestPayload`
- å“åº”ä½“ç±»å‹ï¼š`Dify*Response`
- SSE äº‹ä»¶ç±»å‹ï¼š`Dify*SseEvent`
- é”™è¯¯ç±»å‹ï¼š`DifyApiError`

## å¼€å‘æŒ‡å—

1. **æ·»åŠ æ–°ç«¯ç‚¹**ï¼šéµå¾ª [dify-integration-rule.mdc](mdc:.cursor/rules/dify-integration-rule.mdc) ä¸­çš„æµç¨‹
2. **æ–‡ä»¶å‘½å**ï¼šéµå¾ª [file-naming.mdc](mdc:.cursor/rules/file-naming.mdc) è§„èŒƒ
3. **æäº¤è§„èŒƒ**ï¼šéµå¾ª [git-commit-rule.mdc](mdc:.cursor/rules/git-commit-rule.mdc) æ ¼å¼

## æ€»è®¡

- **æ€»ç«¯ç‚¹æ•°**: 25 ä¸ª
- **æœåŠ¡æ–‡ä»¶æ•°**: 7 ä¸ª
- **æ”¯æŒçš„åº”ç”¨ç±»å‹**: 5 ç§ (chatbot, agent, chatflow, workflow, text-generation)
- **è¦†ç›–ç‡**: 100% Dify API åŠŸèƒ½
