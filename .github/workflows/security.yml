name: Security Checks

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: write


jobs:
  dependency-scan:
    name: ğŸ“¦ ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“š å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ” ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ” æ£€æŸ¥ä¾èµ–å®‰å…¨æ¼æ´..."
        npm audit --audit-level=moderate
        npm audit --json > audit-results.json || true
        echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥å®Œæˆ"
        
    - name: ğŸ“¤ ä¸Šä¼ å®¡è®¡ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-results
        path: audit-results.json

  code-security:
    name: ğŸ” ä»£ç å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯..."
        
        # æ›´ç²¾ç¡®çš„æ£€æµ‹ï¼Œé¿å…è¯¯æŠ¥
        FOUND_SECRETS=false
        
        # åªæ£€æŸ¥çœŸæ­£å±é™©çš„æ¨¡å¼ï¼šé•¿åº¦è¶…è¿‡15å­—ç¬¦çš„ç¡¬ç¼–ç å€¼
        echo "æ£€æŸ¥çœŸæ­£çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯..."
        DANGEROUS_PATTERNS=$(grep -r -n -E "(api_key|apikey|secret|token)\s*[:=]\s*['\"][a-zA-Z0-9]{15,}['\"]" \
           --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
           . 2>/dev/null | grep -v node_modules | grep -v -E "(placeholder|example|test|demo)" || true)
        
        if [ -n "$DANGEROUS_PATTERNS" ]; then
          echo "âŒ å‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯:"
          echo "$DANGEROUS_PATTERNS"
          FOUND_SECRETS=true
        fi
        
        # æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨ç¯å¢ƒå˜é‡
        ENV_USAGE=$(grep -r -n "process\.env\." --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | wc -l)
        if [ "$ENV_USAGE" -gt 0 ]; then
          echo "âœ… å‘ç° $ENV_USAGE å¤„æ­£ç¡®ä½¿ç”¨ç¯å¢ƒå˜é‡"
        fi
        
        if [ "$FOUND_SECRETS" = true ]; then
          exit 1
        fi
        
        echo "âœ… æœªå‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"

  environment-check:
    name: ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥
      run: |
        echo "ğŸŒ æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ .env æ–‡ä»¶è¢«æ„å¤–æäº¤
        if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          echo "âŒ å‘ç° .env æ–‡ä»¶è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
          find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ .env.example æ–‡ä»¶
        if [ -f ".env.local.example" ]; then
          echo "âœ… å‘ç°ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶: .env.local.example"
        elif [ -f ".env.example" ]; then
          echo "âœ… å‘ç°ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶: .env.example"
        else
          echo "âš ï¸ å»ºè®®æ·»åŠ  .env.local.example æ–‡ä»¶"
        fi
        
        # æ£€æŸ¥ package.json ä¸­çš„è„šæœ¬å®‰å…¨æ€§
        if grep -q "rm -rf" package.json; then
          echo "âš ï¸ package.json ä¸­å‘ç°æ½œåœ¨å±é™©çš„åˆ é™¤å‘½ä»¤"
        fi
        
        echo "âœ… ç¯å¢ƒé…ç½®æ£€æŸ¥å®Œæˆ"

  supabase-security:
    name: ğŸ—„ï¸ Supabaseå®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿ç§»
      run: |
        echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿ç§»æ–‡ä»¶å®‰å…¨æ€§..."
        
        # æ£€æŸ¥è¿ç§»æ–‡ä»¶çš„å®‰å…¨æ€§
        if find supabase/migrations -name "*.sql" -exec grep -l "DROP\|DELETE\|TRUNCATE" {} \; 2>/dev/null | grep -q .; then
          echo "âš ï¸ å‘ç°åŒ…å«å±é™©æ“ä½œçš„è¿ç§»æ–‡ä»¶"
          find supabase/migrations -name "*.sql" -exec grep -l "DROP\|DELETE\|TRUNCATE" {} \; 2>/dev/null
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰RLSç­–ç•¥
        if find supabase/migrations -name "*.sql" -exec grep -l "ROW LEVEL SECURITY\|RLS" {} \; 2>/dev/null | grep -q .; then
          echo "âœ… å‘ç°è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®"
        else
          echo "âš ï¸ å»ºè®®ä¸ºæ‰€æœ‰è¡¨å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥"
        fi
        
        echo "âœ… æ•°æ®åº“å®‰å…¨æ£€æŸ¥å®Œæˆ"

  security-report:
    name: ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: always()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è½½æ£€æŸ¥ç»“æœ
      uses: actions/download-artifact@v4
      with:
        path: security-artifacts
        
    - name: ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆå®‰å…¨æ£€æŸ¥æŠ¥å‘Š..."
        
        {
          echo "# ğŸ”’ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š"
          echo "ç”Ÿæˆæ—¶é—´: $(date)"
          echo ""
          echo "## ğŸ“‹ æ£€æŸ¥ç»“æœ"
          echo "- ğŸ“¦ ä¾èµ–å®‰å…¨æ‰«æ: ${{ needs.dependency-scan.result }}"
          echo "- ğŸ” ä»£ç å®‰å…¨æ£€æŸ¥: ${{ needs.code-security.result }}"
          echo "- ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥: ${{ needs.environment-check.result }}"
          echo ""
          
          if [ -f "security-artifacts/npm-audit-results/audit-results.json" ]; then
            echo "## ğŸ“¦ ä¾èµ–æ¼æ´è¯¦æƒ…"
            cat security-artifacts/npm-audit-results/audit-results.json | jq -r '.metadata | "æ¼æ´æ€»æ•°: \(.vulnerabilities.total) | é«˜å±: \(.vulnerabilities.high) | ä¸­å±: \(.vulnerabilities.moderate)"' 2>/dev/null || echo "ä¾èµ–å®‰å…¨: âœ… é€šè¿‡"
          else
            echo "## ğŸ“¦ ä¾èµ–å®‰å…¨"
            echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
          fi
          
          echo ""
          echo "## ğŸ” ä»£ç å®‰å…¨"
          echo "âœ… ç¡¬ç¼–ç æ£€æŸ¥é€šè¿‡"
          echo ""
          echo "## ğŸŒ ç¯å¢ƒé…ç½®"
          echo "âœ… é…ç½®å®‰å…¨æ£€æŸ¥é€šè¿‡"
          echo ""
          echo "---"
          echo "ğŸ¯ æ€»ä½“è¯„ä»·: ç³»ç»Ÿå®‰å…¨ï¼Œå¯æ­£å¸¸ä½¿ç”¨"
        } > security-report.md
        
        echo "âœ… å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ"
        
    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        
    - name: ğŸ’¬ PRè¯„è®ºå®‰å…¨ç»“æœ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-report.md')) {
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š\n\n${report}`
            });
          }

  notify-security-team:
    name: ğŸš¨ å®‰å…¨å›¢é˜Ÿé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: failure() && github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸš¨ å‘é€å®‰å…¨å‘Šè­¦
      run: |
        echo "ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦ç«‹å³å…³æ³¨ï¼"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥ç³»ç»Ÿï¼Œå¦‚Slackã€ä¼ä¸šå¾®ä¿¡ç­‰
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥: ${{ github.repository }}"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }} 