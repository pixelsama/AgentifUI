name: Security Checks

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dependency-scan:
    name: ğŸ“¦ ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ è®¾ç½® pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
        
    - name: ğŸ“š å®‰è£…ä¾èµ–
      run: |
        echo "æ£€æŸ¥ pnpm-lock.yaml çŠ¶æ€..."
        if [ -f "pnpm-lock.yaml" ]; then
          echo "âœ… å‘ç° pnpm-lock.yaml"
          echo "å°è¯•ä½¿ç”¨å†»ç»“é”æ–‡ä»¶å®‰è£…..."
          if pnpm install --frozen-lockfile; then
            echo "âœ… å†»ç»“é”æ–‡ä»¶å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ å†»ç»“é”æ–‡ä»¶å®‰è£…å¤±è´¥ï¼Œä½¿ç”¨å¸¸è§„å®‰è£…..."
            pnpm install --no-frozen-lockfile
          fi
        else
          echo "âŒ æœªå‘ç° pnpm-lock.yamlï¼Œæ‰§è¡Œå¸¸è§„å®‰è£…..."
          pnpm install
        fi
        
    - name: ğŸ” ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ” æ£€æŸ¥ä¾èµ–å®‰å…¨æ¼æ´..."
        
        # ä½¿ç”¨ pnpm audit
        echo "è¿è¡Œ pnpm audit..."
        if pnpm audit --audit-level=moderate; then
          echo "âœ… æœªå‘ç°ä¸­çº§ä»¥ä¸Šå®‰å…¨æ¼æ´"
        else
          echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œä½†ç»§ç»­æ‰§è¡Œä»¥ç”ŸæˆæŠ¥å‘Š"
        fi
        
        # ç”Ÿæˆ JSON æŠ¥å‘Š
        pnpm audit --json > audit-results.json || true
        
        # æ£€æŸ¥å…³é”®æ¼æ´
        if pnpm audit --audit-level=critical --json | jq -e '.metadata.vulnerabilities.critical > 0' > /dev/null 2>&1; then
          echo "âŒ å‘ç°å…³é”®å®‰å…¨æ¼æ´ï¼"
          pnpm audit --audit-level=critical
          exit 1
        fi
        
        echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥å®Œæˆ"
        
    - name: ğŸ“¤ ä¸Šä¼ å®¡è®¡ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: pnpm-audit-results
        path: audit-results.json

  code-security:
    name: ğŸ” ä»£ç å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯..."
        
        # æ›´ç²¾ç¡®çš„æ£€æµ‹ï¼Œé¿å…è¯¯æŠ¥
        FOUND_SECRETS=false
        
        # æ£€æŸ¥çœŸæ­£çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ï¼ˆé•¿åº¦è¶…è¿‡15å­—ç¬¦ï¼‰
        echo "æ£€æŸ¥ç¡¬ç¼–ç  API å¯†é’¥å’Œä»¤ç‰Œ..."
        DANGEROUS_PATTERNS=$(grep -r -n -E "(api_key|apikey|secret|token|password)\s*[:=]\s*['\"][a-zA-Z0-9+/]{15,}['\"]" \
           --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" \
           . 2>/dev/null | \
           grep -v node_modules | \
           grep -v -E "(placeholder|example|test|demo|sample|mock)" || true)
        
        if [ -n "$DANGEROUS_PATTERNS" ]; then
          echo "âŒ å‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯:"
          echo "$DANGEROUS_PATTERNS"
          FOUND_SECRETS=true
        fi
        
        # æ£€æŸ¥ Supabase ç›¸å…³çš„ç¡¬ç¼–ç 
        echo "æ£€æŸ¥ Supabase é…ç½®..."
        SUPABASE_PATTERNS=$(grep -r -n -E "(supabase.*url|supabase.*key)" \
           --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
           . 2>/dev/null | \
           grep -v node_modules | \
           grep -v "process\.env" | \
           grep -v -E "(placeholder|example|docs)" || true)
        
        if [ -n "$SUPABASE_PATTERNS" ]; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ Supabase ç¡¬ç¼–ç é…ç½®:"
          echo "$SUPABASE_PATTERNS"
          echo "è¯·ç¡®ä¿ä½¿ç”¨ç¯å¢ƒå˜é‡"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨ç¯å¢ƒå˜é‡
        ENV_USAGE=$(grep -r -n "process\.env\." --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | wc -l)
        if [ "$ENV_USAGE" -gt 0 ]; then
          echo "âœ… å‘ç° $ENV_USAGE å¤„æ­£ç¡®ä½¿ç”¨ç¯å¢ƒå˜é‡"
        fi
        
        if [ "$FOUND_SECRETS" = true ]; then
          echo "âŒ å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼šå‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
          exit 1
        fi
        
        echo "âœ… æœªå‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"

  environment-check:
    name: ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥
      run: |
        echo "ğŸŒ æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ .env æ–‡ä»¶è¢«æ„å¤–æäº¤
        if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          echo "âŒ å‘ç° .env æ–‡ä»¶è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
          find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*"
          exit 1
        fi
        
        # æ£€æŸ¥åŒ…ç®¡ç†å™¨é”æ–‡ä»¶ä¸€è‡´æ€§
        if [ -f "package-lock.json" ] && [ -f "pnpm-lock.yaml" ]; then
          echo "âŒ å‘ç°å¤šä¸ªåŒ…ç®¡ç†å™¨é”æ–‡ä»¶ï¼Œè¯·ç»Ÿä¸€ä½¿ç”¨ pnpm"
          exit 1
        fi
        
        if [ -f "yarn.lock" ] && [ -f "pnpm-lock.yaml" ]; then
          echo "âŒ å‘ç°å¤šä¸ªåŒ…ç®¡ç†å™¨é”æ–‡ä»¶ï¼Œè¯·ç»Ÿä¸€ä½¿ç”¨ pnpm"
          exit 1
        fi
        
        if [ ! -f "pnpm-lock.yaml" ]; then
          echo "âš ï¸ æœªå‘ç° pnpm-lock.yamlï¼Œå»ºè®®ä½¿ç”¨ pnpm ç®¡ç†ä¾èµ–"
        else
          echo "âœ… ä½¿ç”¨ pnpm ç®¡ç†ä¾èµ–ï¼Œé”æ–‡ä»¶å­˜åœ¨"
          
          # æ£€æŸ¥ lockfile ç‰ˆæœ¬
          LOCKFILE_VERSION=$(grep "lockfileVersion:" pnpm-lock.yaml | head -1 | sed "s/lockfileVersion: '\(.*\)'/\1/")
          echo "ğŸ“‹ æ£€æµ‹åˆ° pnpm-lock.yaml ç‰ˆæœ¬: $LOCKFILE_VERSION"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
        if [ -f ".env.local.example" ]; then
          echo "âœ… å‘ç°ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶: .env.local.example"
        elif [ -f ".env.example" ]; then
          echo "âœ… å‘ç°ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶: .env.example"
        else
          echo "âš ï¸ å»ºè®®æ·»åŠ  .env.local.example æ–‡ä»¶ä½œä¸ºç¯å¢ƒå˜é‡æ¨¡æ¿"
        fi
        
        # æ£€æŸ¥ package.json ä¸­çš„è„šæœ¬å®‰å…¨æ€§
        if grep -q "rm -rf" package.json; then
          echo "âš ï¸ package.json ä¸­å‘ç°æ½œåœ¨å±é™©çš„åˆ é™¤å‘½ä»¤"
        fi
        
        # æ£€æŸ¥ Next.js é…ç½®
        if [ -f "next.config.js" ] || [ -f "next.config.mjs" ] || [ -f "next.config.ts" ]; then
          echo "âœ… å‘ç° Next.js é…ç½®æ–‡ä»¶"
        fi
        
        echo "âœ… ç¯å¢ƒé…ç½®æ£€æŸ¥å®Œæˆ"

  supabase-security:
    name: ğŸ—„ï¸ Supabaseå®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿ç§»
      run: |
        echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿ç§»æ–‡ä»¶å®‰å…¨æ€§..."
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Supabase ç›®å½•
        if [ -d "supabase" ]; then
          echo "âœ… å‘ç° Supabase é¡¹ç›®ç»“æ„"
          
          # æ£€æŸ¥è¿ç§»æ–‡ä»¶çš„å®‰å…¨æ€§
          if [ -d "supabase/migrations" ]; then
            if find supabase/migrations -name "*.sql" -exec grep -l "DROP\|DELETE\|TRUNCATE" {} \; 2>/dev/null | grep -q .; then
              echo "âš ï¸ å‘ç°åŒ…å«å±é™©æ“ä½œçš„è¿ç§»æ–‡ä»¶:"
              find supabase/migrations -name "*.sql" -exec grep -l "DROP\|DELETE\|TRUNCATE" {} \; 2>/dev/null
              echo "è¯·ç¡®ä¿è¿™äº›æ“ä½œæ˜¯æœ‰æ„çš„"
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰RLSç­–ç•¥
            if find supabase/migrations -name "*.sql" -exec grep -l "ROW LEVEL SECURITY\|RLS" {} \; 2>/dev/null | grep -q .; then
              echo "âœ… å‘ç°è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®"
            else
              echo "âš ï¸ å»ºè®®ä¸ºæ‰€æœ‰è¡¨å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥"
            fi
          else
            echo "âš ï¸ æœªå‘ç°è¿ç§»æ–‡ä»¶ç›®å½•"
          fi
        else
          echo "â„¹ï¸ æœªå‘ç° Supabase ç›®å½•ï¼Œè·³è¿‡æ•°æ®åº“æ£€æŸ¥"
        fi
        
        echo "âœ… æ•°æ®åº“å®‰å…¨æ£€æŸ¥å®Œæˆ"

  security-report:
    name: ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: always()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ä¸‹è½½æ£€æŸ¥ç»“æœ
      uses: actions/download-artifact@v4
      with:
        path: security-artifacts
        
    - name: ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆå®‰å…¨æ£€æŸ¥æŠ¥å‘Š..."
        
        {
          echo "# ğŸ”’ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š"
          echo "ç”Ÿæˆæ—¶é—´: $(date)"
          echo "é¡¹ç›®: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo ""
          echo "## ğŸ“‹ æ£€æŸ¥ç»“æœ"
          echo "- ğŸ“¦ ä¾èµ–å®‰å…¨æ‰«æ: ${{ needs.dependency-scan.result }}"
          echo "- ğŸ” ä»£ç å®‰å…¨æ£€æŸ¥: ${{ needs.code-security.result }}"
          echo "- ğŸŒ ç¯å¢ƒé…ç½®æ£€æŸ¥: ${{ needs.environment-check.result }}"
          echo ""
          
          if [ -f "security-artifacts/pnpm-audit-results/audit-results.json" ]; then
            echo "## ğŸ“¦ ä¾èµ–æ¼æ´è¯¦æƒ…"
            echo '```json'
            if command -v jq >/dev/null 2>&1; then
              cat security-artifacts/pnpm-audit-results/audit-results.json | jq -r '.metadata | "æ¼æ´æ€»æ•°: \(.vulnerabilities.total) | é«˜å±: \(.vulnerabilities.high) | ä¸­å±: \(.vulnerabilities.moderate) | ä½å±: \(.vulnerabilities.low)"' 2>/dev/null || echo "æ— æ³•è§£æä¾èµ–æ‰«æç»“æœ"
            else
              echo "ä¾èµ–å®‰å…¨æ‰«æå·²å®Œæˆï¼Œè¯¦ç»†ç»“æœè¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—"
            fi
            echo '```'
          else
            echo "## ğŸ“¦ ä¾èµ–å®‰å…¨"
            echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´æˆ–æ‰«ææœªç”Ÿæˆç»“æœæ–‡ä»¶"
          fi
          
          echo ""
          echo "## ğŸ” ä»£ç å®‰å…¨"
          if [ "${{ needs.code-security.result }}" = "success" ]; then
            echo "âœ… ç¡¬ç¼–ç æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ ç¡¬ç¼–ç æ£€æŸ¥å‘ç°é—®é¢˜"
          fi
          
          echo ""
          echo "## ğŸŒ ç¯å¢ƒé…ç½®"
          if [ "${{ needs.environment-check.result }}" = "success" ]; then
            echo "âœ… é…ç½®å®‰å…¨æ£€æŸ¥é€šè¿‡"
            echo "âœ… åŒ…ç®¡ç†å™¨é…ç½®ä¸€è‡´"
          else
            echo "âŒ ç¯å¢ƒé…ç½®æ£€æŸ¥å‘ç°é—®é¢˜"
          fi
          
          echo ""
          echo "## ğŸ› ï¸ æŠ€æœ¯æ ˆä¿¡æ¯"
          echo "- åŒ…ç®¡ç†å™¨: pnpm"
          echo "- Node.js ç‰ˆæœ¬: 18"
          echo "- æ¡†æ¶: Next.js 15.3.1"
          echo "- æ•°æ®åº“: Supabase"
          
          echo ""
          echo "---"
          
          # ç”Ÿæˆæ€»ä½“è¯„ä»·
          if [ "${{ needs.dependency-scan.result }}" = "success" ] && [ "${{ needs.code-security.result }}" = "success" ] && [ "${{ needs.environment-check.result }}" = "success" ]; then
            echo "ğŸ¯ æ€»ä½“è¯„ä»·: âœ… ç³»ç»Ÿå®‰å…¨ï¼Œå¯æ­£å¸¸ä½¿ç”¨"
          else
            echo "ğŸ¯ æ€»ä½“è¯„ä»·: âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—å¹¶ä¿®å¤"
          fi
          
          echo ""
          echo "## ğŸ”§ å»ºè®®æ“ä½œ"
          echo "1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬"
          echo "2. ç¡®ä¿æ‰€æœ‰æ•æ„Ÿé…ç½®ä½¿ç”¨ç¯å¢ƒå˜é‡"
          echo "3. ä¸º Supabase è¡¨å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥(RLS)"
          echo "4. å®šæœŸå®¡æŸ¥å’Œè½®æ¢ API å¯†é’¥"
          echo "5. ä½¿ç”¨ \`pnpm audit fix\` ä¿®å¤å¯ä¿®å¤çš„æ¼æ´"
          
        } > security-report.md
        
        echo "âœ… å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat security-report.md
        
    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 30
        
    - name: ğŸ’¬ PRè¯„è®ºå®‰å…¨ç»“æœ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-report.md')) {
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            // é™åˆ¶è¯„è®ºé•¿åº¦ï¼Œé¿å…è¿‡é•¿
            const maxLength = 60000;
            const truncatedReport = report.length > maxLength 
              ? report.substring(0, maxLength) + '\n\n... (æŠ¥å‘Šè¢«æˆªæ–­ï¼Œå®Œæ•´æŠ¥å‘Šè¯·æŸ¥çœ‹ Artifacts)'
              : report;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š\n\n${truncatedReport}`
            });
          }

  notify-security-team:
    name: ğŸš¨ å®‰å…¨å›¢é˜Ÿé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: failure() && github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸš¨ å‘é€å®‰å…¨å‘Šè­¦
      run: |
        echo "ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦ç«‹å³å…³æ³¨ï¼"
        echo "ğŸ“‹ å¤±è´¥è¯¦æƒ…:"
        echo "- ä»“åº“: ${{ github.repository }}"
        echo "- åˆ†æ”¯: ${{ github.ref }}"
        echo "- æäº¤: ${{ github.sha }}"
        echo "- æäº¤è€…: ${{ github.actor }}"
        echo "- å·¥ä½œæµ: ${{ github.workflow }}"
        echo "- è¿è¡ŒID: ${{ github.run_id }}"
        echo "- è¯¦æƒ…é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        echo ""
        echo "ğŸ“Š å„é¡¹æ£€æŸ¥ç»“æœ:"
        echo "- ä¾èµ–å®‰å…¨æ‰«æ: ${{ needs.dependency-scan.result }}"
        echo "- ä»£ç å®‰å…¨æ£€æŸ¥: ${{ needs.code-security.result }}"
        echo "- ç¯å¢ƒé…ç½®æ£€æŸ¥: ${{ needs.environment-check.result }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥ç³»ç»Ÿ
        # ä¾‹å¦‚ Slackã€ä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ç­‰
        
        # Slack é€šçŸ¥ç¤ºä¾‹ (éœ€è¦é…ç½® SLACK_WEBHOOK_URL secret)
        # curl -X POST -H 'Content-type: application/json' \
        #   --data "{
        #     \"text\": \"ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥\",
        #     \"blocks\": [
        #       {
        #         \"type\": \"section\",
        #         \"text\": {
        #           \"type\": \"mrkdwn\",
        #           \"text\": \"*ä»“åº“:* ${{ github.repository }}\\n*åˆ†æ”¯:* ${{ github.ref }}\\n*è¯¦æƒ…:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
        #         }
        #       }
        #     ]
        #   }" \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

  auto-fix:
    name: ğŸ”§ è‡ªåŠ¨ä¿®å¤
    runs-on: ubuntu-latest
    needs: [dependency-scan]
    if: |
      needs.dependency-scan.result == 'failure' && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/develop' &&
      contains(github.event.head_commit.message, '[auto-fix]')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ”§ è®¾ç½® pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
        
    - name: ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤ä¾èµ–æ¼æ´
      run: |
        echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤ä¾èµ–å®‰å…¨æ¼æ´..."
        
        # å®‰è£…ä¾èµ–
        pnpm install --frozen-lockfile
        
        # å°è¯•è‡ªåŠ¨ä¿®å¤
        if pnpm audit fix; then
          echo "âœ… è‡ªåŠ¨ä¿®å¤æˆåŠŸ"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          else
            echo "ğŸ“ å‘ç°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤ä¾èµ–å®‰å…¨æ¼æ´ [skip ci]"
            git push
            echo "âœ… è‡ªåŠ¨ä¿®å¤å·²æäº¤"
          fi
        else
          echo "âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
          exit 1
        fi

  weekly-dependency-update:
    name: ğŸ“¦ æ¯å‘¨ä¾èµ–æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ”§ è®¾ç½® pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
        
    - name: ğŸ“¦ æ£€æŸ¥è¿‡æœŸä¾èµ–
      run: |
        echo "ğŸ“¦ æ£€æŸ¥è¿‡æœŸä¾èµ–åŒ…..."
        
        # å®‰è£…ä¾èµ–
        pnpm install --frozen-lockfile
        
        # æ£€æŸ¥è¿‡æœŸåŒ…
        echo "æ£€æŸ¥è¿‡æœŸçš„ä¾èµ–åŒ…..."
        pnpm outdated > outdated-packages.txt 2>&1 || true
        
        if [ -s outdated-packages.txt ]; then
          echo "ğŸ“‹ å‘ç°è¿‡æœŸçš„ä¾èµ–åŒ…:"
          cat outdated-packages.txt
          
          # åˆ›å»º Issue
          cat > issue-body.md << 'EOF'
        ## ğŸ“¦ æ¯å‘¨ä¾èµ–æ›´æ–°æŠ¥å‘Š
        
        æœ¬æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆï¼Œåˆ—å‡ºäº†å½“å‰é¡¹ç›®ä¸­çš„è¿‡æœŸä¾èµ–åŒ…ã€‚
        
        ### ğŸ“‹ è¿‡æœŸä¾èµ–åˆ—è¡¨
        
        ```
        EOF
          cat outdated-packages.txt >> issue-body.md
          echo '```' >> issue-body.md
          cat >> issue-body.md << 'EOF'
        
        ### ğŸ”§ å»ºè®®æ“ä½œ
        
        1. **å®¡æŸ¥ä¾èµ–æ›´æ–°**: æ£€æŸ¥æ¯ä¸ªè¿‡æœŸåŒ…çš„æ›´æ–°æ—¥å¿—
        2. **æµ‹è¯•å…¼å®¹æ€§**: ç¡®ä¿æ–°ç‰ˆæœ¬ä¸å½“å‰ä»£ç å…¼å®¹
        3. **å®‰å…¨ä¼˜å…ˆ**: ä¼˜å…ˆæ›´æ–°æœ‰å®‰å…¨æ¼æ´çš„åŒ…
        4. **æ‰¹é‡æ›´æ–°**: å¯ä»¥ä½¿ç”¨ `pnpm update` è¿›è¡Œæ‰¹é‡æ›´æ–°
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        
        - ä¸»ç‰ˆæœ¬å·æ›´æ–°å¯èƒ½åŒ…å«ç ´åæ€§å˜æ›´
        - å»ºè®®åœ¨å¼€å‘åˆ†æ”¯è¿›è¡Œæµ‹è¯•åå†åˆå¹¶åˆ°ä¸»åˆ†æ”¯
        - å…³æ³¨ Next.jsã€React ç­‰æ ¸å¿ƒæ¡†æ¶çš„æ›´æ–°
        
        ---
        *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
        EOF
          
          echo "âœ… ä¾èµ–æ›´æ–°æŠ¥å‘Šå·²ç”Ÿæˆ"
        else
          echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: dependency-update-report
        path: |
          outdated-packages.txt
          issue-body.md
        retention-days: 7
        
    - name: ğŸ¯ åˆ›å»ºä¾èµ–æ›´æ–°Issue
      if: hashFiles('outdated-packages.txt') != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('issue-body.md')) {
            const body = fs.readFileSync('issue-body.md', 'utf8');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„ Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automation'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('æ¯å‘¨ä¾èµ–æ›´æ–°æŠ¥å‘Š')
            );
            
            if (existingIssue) {
              // æ›´æ–°ç°æœ‰ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ“¦ ä¾èµ–æ›´æ–°æŠ¥å‘Š - ${new Date().toLocaleDateString()}\n\n${body}`
              });
              console.log('å·²æ›´æ–°ç°æœ‰çš„ä¾èµ–æ›´æ–° Issue');
            } else {
              // åˆ›å»ºæ–° Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“¦ æ¯å‘¨ä¾èµ–æ›´æ–°æŠ¥å‘Š - ${new Date().toLocaleDateString()}`,
                body: body,
                labels: ['dependencies', 'automation', 'enhancement']
              });
              console.log('å·²åˆ›å»ºæ–°çš„ä¾èµ–æ›´æ–° Issue');
            }
          }

