name: Security Checks

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ£€æŸ¥
    - cron: '0 2 * * *'

jobs:
  dependency-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate
        npm audit --json > audit-results.json || true
        
    - name: Upload audit results
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-results
        path: audit-results.json
        
  code-security:
    name: ä»£ç å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint security rules
      run: |
        npx eslint . --ext .ts,.tsx,.js,.jsx \
          --format json \
          --output-file eslint-security-results.json || true
          
    - name: TypeScript security check
      run: |
        npx tsc --noEmit --strict
        
    - name: Check for hardcoded secrets
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥æˆ–æ•æ„Ÿä¿¡æ¯
        if grep -r -i "password\|secret\|key\|token" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | grep -v ".git" | grep -E "(=|:)\s*['\"][^'\"]{10,}['\"]"; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
          exit 1
        fi
        
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: code-security-results
        path: eslint-security-results.json

  environment-check:
    name: ç¯å¢ƒé…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check environment files
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ .env æ–‡ä»¶è¢«æ„å¤–æäº¤
        if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
          echo "âŒ å‘ç° .env æ–‡ä»¶è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ .env.example æ–‡ä»¶
        if [ ! -f ".env.local.example" ]; then
          echo "âš ï¸ ç¼ºå°‘ .env.local.example æ–‡ä»¶"
        fi
        
        # æ£€æŸ¥ package.json ä¸­çš„è„šæœ¬å®‰å…¨æ€§
        if grep -q "rm -rf" package.json; then
          echo "âš ï¸ package.json ä¸­å‘ç°æ½œåœ¨å±é™©çš„åˆ é™¤å‘½ä»¤"
        fi

  supabase-security:
    name: Supabaseå®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Check database migrations
      run: |
        # æ£€æŸ¥è¿ç§»æ–‡ä»¶çš„å®‰å…¨æ€§
        if find supabase/migrations -name "*.sql" -exec grep -l "DROP\|DELETE\|TRUNCATE" {} \; | grep -q .; then
          echo "âš ï¸ å‘ç°åŒ…å«å±é™©æ“ä½œçš„è¿ç§»æ–‡ä»¶"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰RLSç­–ç•¥
        if ! find supabase/migrations -name "*.sql" -exec grep -l "ROW LEVEL SECURITY\|RLS" {} \; | grep -q .; then
          echo "âš ï¸ å»ºè®®ä¸ºæ‰€æœ‰è¡¨å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥"
        fi

  security-report:
    name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: security-artifacts
        
    - name: Generate security report
      run: |
        echo "# å®‰å…¨æ£€æŸ¥æŠ¥å‘Š" > security-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> security-report.md
        echo "" >> security-report.md
        
        echo "## æ£€æŸ¥ç»“æœ" >> security-report.md
        echo "- ä¾èµ–å®‰å…¨æ‰«æ: ${{ needs.dependency-scan.result }}" >> security-report.md
        echo "- ä»£ç å®‰å…¨æ£€æŸ¥: ${{ needs.code-security.result }}" >> security-report.md
        echo "- ç¯å¢ƒé…ç½®æ£€æŸ¥: ${{ needs.environment-check.result }}" >> security-report.md
        echo "" >> security-report.md
        
        if [ -f "security-artifacts/npm-audit-results/audit-results.json" ]; then
          echo "## ä¾èµ–æ¼æ´è¯¦æƒ…" >> security-report.md
          cat security-artifacts/npm-audit-results/audit-results.json | jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' >> security-report.md || echo "æ— æ¼æ´å‘ç°" >> security-report.md
        fi
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        
    - name: Comment PR with security results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-report.md')) {
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š\n\n${report}`
            });
          }

  notify-security-team:
    name: å®‰å…¨å›¢é˜Ÿé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, environment-check]
    if: failure() && github.ref == 'refs/heads/master'
    
    steps:
    - name: Send security alert
      run: |
        echo "ğŸš¨ å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦ç«‹å³å…³æ³¨ï¼"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥ç³»ç»Ÿï¼Œå¦‚Slackã€ä¼ä¸šå¾®ä¿¡ç­‰
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"å®‰å…¨æ£€æŸ¥å¤±è´¥: ${{ github.repository }}"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }} 